# ğŸš¨ å…¨é¢ä¿®å¤ 401 é”™è¯¯ - å®Œæˆæ€»ç»“

## ä¿®å¤æ—¶é—´
2026-01-03

## âœ… å·²å®Œæˆçš„ä¿®å¤

### 1. âœ… åç«¯é”™è¯¯å¤„ç†å¢å¼º

**æ–‡ä»¶**: `voice_bridge.py`

**ä¿®å¤å†…å®¹**:
- âœ… Cartesia å®¢æˆ·ç«¯åˆå§‹åŒ–é”™è¯¯æ•è·
- âœ… TTS API è°ƒç”¨é”™è¯¯æ•è·
- âœ… æ˜ç¡®åŒºåˆ† 401ï¼ˆè®¤è¯å¤±è´¥ï¼‰å’Œ 429ï¼ˆé…é¢ç”¨å®Œï¼‰
- âœ… è¯¦ç»†çš„é”™è¯¯æ¶ˆæ¯ï¼ŒæŒ‡å¯¼ç”¨æˆ·æ£€æŸ¥ `.env` æ–‡ä»¶

**å…³é”®ä»£ç **:
```python
try:
    client = Cartesia(api_key=CARTESIA_API_KEY)
except Exception as cartesia_init_error:
    if "401" in str(cartesia_init_error):
        raise HTTPException(
            status_code=401,
            detail="Cartesia API è®¤è¯å¤±è´¥ï¼ˆ401ï¼‰ï¼šAPI Key æ— æ•ˆæˆ–å·²è¿‡æœŸã€‚è¯·æ£€æŸ¥ .env æ–‡ä»¶ä¸­çš„ CARTESIA_API_KEYã€‚"
        )

try:
    audio_stream = client.tts.bytes(**tts_args)
except Exception as tts_error:
    if "401" in str(tts_error):
        raise HTTPException(
            status_code=401,
            detail="Cartesia TTS API è®¤è¯å¤±è´¥ï¼ˆ401ï¼‰ï¼šAPI Key æ— æ•ˆæˆ–å·²è¿‡æœŸã€‚"
        )
```

### 2. âœ… å‰ç«¯é”™è¯¯å¤„ç†å¢å¼º

**æ–‡ä»¶**: `static/phi_chat.html`

**ä¿®å¤å†…å®¹**:
- âœ… åœ¨ fetch è°ƒç”¨åç«‹å³æ£€æŸ¥å“åº”çŠ¶æ€
- âœ… æ­£ç¡®è§£æé”™è¯¯å“åº”ï¼ˆJSON æˆ–æ–‡æœ¬ï¼‰
- âœ… æä¾›æ¸…æ™°çš„é”™è¯¯æ¶ˆæ¯æ˜¾ç¤º

**å…³é”®ä»£ç **:
```javascript
// ç«‹å³æ£€æŸ¥å“åº”çŠ¶æ€
if (!response.ok) {
    hideTyping();
    let errorDetail = '';
    try {
        const errorData = await response.json();
        errorDetail = errorData.detail || errorData.error || JSON.stringify(errorData);
    } catch (e) {
        errorDetail = await response.text() || `HTTP ${response.status}`;
    }
    
    const errorMessage = `ç”Ÿæˆå›å¤æ—¶å‡ºé”™: ${response.status} - ${errorDetail}`;
    addMessage('assistant', errorMessage);
    showStatus(`âŒ API é”™è¯¯ (${response.status})`, 'error');
    return;
}
```

### 3. âœ… ç¯å¢ƒå˜é‡å¼ºåˆ¶åŠ è½½

**å·²ç¡®è®¤**: `voice_bridge.py` é¡¶éƒ¨å·²å®ç°ï¼š
- âœ… `load_dotenv(_env_path, override=True)` å¼ºåˆ¶è¦†ç›–
- âœ… æ‰‹åŠ¨è§£æå¤„ç† BOM
- âœ… è°ƒè¯•è¾“å‡ºç¡®è®¤ Key åŠ è½½

### 4. âœ… API Key éªŒè¯

**å·²ç¡®è®¤**: 
- âœ… å¯åŠ¨æ—¶éªŒè¯ CARTESIA_API_KEY
- âœ… æ¯æ¬¡è°ƒç”¨å‰éªŒè¯
- âœ… è¯¦ç»†çš„é”™è¯¯æ¶ˆæ¯

## ğŸ“‹ ä¿®å¤æ¸…å•

- [x] åç«¯ Cartesia API é”™è¯¯å¤„ç†å¢å¼º
- [x] å‰ç«¯é”™è¯¯å“åº”è§£ææ”¹è¿›
- [x] ç¯å¢ƒå˜é‡å¼ºåˆ¶åŠ è½½
- [x] API Key éªŒè¯å’Œè°ƒè¯•è¾“å‡º
- [x] è¯¦ç»†çš„é”™è¯¯æ¶ˆæ¯æŒ‡å¯¼

## ğŸš€ ä¸‹ä¸€æ­¥æ“ä½œ

### æ­¥éª¤ 1: å…³é—­æ‰€æœ‰è¿›ç¨‹

```powershell
.\kill_python_processes.ps1
```

æˆ–æ‰‹åŠ¨ï¼š
```powershell
Stop-Process -Name python -Force
```

### æ­¥éª¤ 2: éªŒè¯ .env æ–‡ä»¶

ç¡®è®¤ `.env` æ–‡ä»¶åŒ…å«æœ‰æ•ˆçš„ `CARTESIA_API_KEY`:
```env
CARTESIA_API_KEY=your_valid_cartesia_api_key
GEMINI_API_KEY=AIzaSyBhl9-bR6xKe4DW25J25LXU6dxYJsxUuOo
```

### æ­¥éª¤ 3: é‡æ–°å¯åŠ¨æœåŠ¡

```powershell
.\start_voice_bridge.ps1
```

### æ­¥éª¤ 4: æ£€æŸ¥å¯åŠ¨æ—¥å¿—

å¯åŠ¨æ—¶åº”è¯¥çœ‹åˆ°ï¼š
```
DEBUG: Cartesia Key starts with: [å‰5ä¸ªå­—ç¬¦]
Cartesia API Key loaded successfully (length: [é•¿åº¦])
```

### æ­¥éª¤ 5: æµ‹è¯• API

è®¿é—® http://localhost:8000/ å¹¶å‘é€æµ‹è¯•æ¶ˆæ¯ã€‚

**å¦‚æœä»ç„¶å‡ºç° 401 é”™è¯¯**ï¼Œç°åœ¨é”™è¯¯æ¶ˆæ¯ä¼šæ˜ç¡®æŒ‡å‡ºï¼š
- âœ… æ˜¯ Cartesia API è®¤è¯å¤±è´¥
- âœ… éœ€è¦æ£€æŸ¥ `.env` æ–‡ä»¶ä¸­çš„ `CARTESIA_API_KEY`
- âœ… å¯èƒ½æ˜¯ API Key æ— æ•ˆæˆ–å·²è¿‡æœŸ

## ğŸ” é”™è¯¯æ¶ˆæ¯è¯´æ˜

### 401 é”™è¯¯ï¼ˆè®¤è¯å¤±è´¥ï¼‰

**åç«¯è¿”å›**:
```json
{
  "detail": "Cartesia API è®¤è¯å¤±è´¥ï¼ˆ401ï¼‰ï¼šAPI Key æ— æ•ˆæˆ–å·²è¿‡æœŸã€‚è¯·æ£€æŸ¥ .env æ–‡ä»¶ä¸­çš„ CARTESIA_API_KEYã€‚"
}
```

**å‰ç«¯æ˜¾ç¤º**:
```
ç”Ÿæˆå›å¤æ—¶å‡ºé”™: 401 - Cartesia API è®¤è¯å¤±è´¥ï¼ˆ401ï¼‰ï¼šAPI Key æ— æ•ˆæˆ–å·²è¿‡æœŸã€‚è¯·æ£€æŸ¥ .env æ–‡ä»¶ä¸­çš„ CARTESIA_API_KEYã€‚
```

### 429 é”™è¯¯ï¼ˆé…é¢ç”¨å®Œï¼‰

**åç«¯è¿”å›**:
```json
{
  "detail": "Cartesia API é…é¢å·²ç”¨å®Œï¼ˆ429ï¼‰ï¼šè¯·ç¨åå†è¯•æˆ–æ£€æŸ¥é…é¢è®¾ç½®ã€‚"
}
```

## âœ… éªŒè¯æ¸…å•

- [x] åç«¯é”™è¯¯å¤„ç†å·²å¢å¼º
- [x] å‰ç«¯é”™è¯¯å¤„ç†å·²å¢å¼º
- [x] ç¯å¢ƒå˜é‡å¼ºåˆ¶åŠ è½½å·²å®ç°
- [x] API Key éªŒè¯å·²å®ç°
- [x] è¯¦ç»†çš„é”™è¯¯æ¶ˆæ¯å·²æ·»åŠ 
- [x] ä»£ç æ— è¯­æ³•é”™è¯¯

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2026-01-03  
**çŠ¶æ€**: âœ… æ‰€æœ‰é”™è¯¯å¤„ç†å·²å¢å¼ºï¼Œä»£ç å·²ä¿®å¤  
**ä¸‹ä¸€æ­¥**: é‡å¯æœåŠ¡å¹¶æµ‹è¯•

