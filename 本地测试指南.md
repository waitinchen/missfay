# 🧪 本地 LLM 和语音对话测试指南

## 📍 本地测试 URL

### 1. 聊天界面（语音对话）
```
http://localhost:8000/
```
或
```
http://localhost:8000/static/phi_chat.html
```

### 2. API 端点

#### 健康检查
```
http://localhost:8000/health
```

#### 验证环境变量
```
http://localhost:8000/verify-keys
```

#### 聊天端点（生成文本 + 语音）
```
POST http://localhost:8000/chat
Content-Type: application/json

{
  "text": "你好",
  "arousal_level": 2
}
```

#### 语音代理端点（完整对话流程）
```
POST http://localhost:8000/api/v1/phi_voice
Content-Type: application/json

{
  "user_input": "你好",
  "session_id": "test-session"
}
```

#### API 文档（Swagger UI）
```
http://localhost:8000/docs
```

## 🚀 启动服务

### 方法 1: 使用启动脚本（推荐）
```powershell
.\start_voice_bridge.ps1
```

### 方法 2: 直接运行
```powershell
python voice_bridge.py
```

### 方法 3: 使用 uvicorn
```powershell
uvicorn voice_bridge:app --host 0.0.0.0 --port 8000 --reload
```

## 🧪 测试 LLM 是否有效

### 方法 1: 使用测试脚本（推荐）
```powershell
python test_local_llm.py
```

这个脚本会：
- ✅ 验证 GEMINI_API_KEY 是否有效
- ✅ 测试 PhiBrain 初始化
- ✅ 测试生成回复
- ✅ 检查 API 端点是否可访问

### 方法 2: 通过浏览器测试

1. **启动服务**后，访问：
   ```
   http://localhost:8000/
   ```

2. **检查健康状态**：
   - 查看右上角的 "LLM: OK/ERROR" 和 "TTS: OK/ERROR" 状态

3. **发送测试消息**：
   - 在输入框中输入 "你好"
   - 点击 "发送" 按钮
   - 如果 LLM 正常，应该会收到回复

### 方法 3: 使用 curl 测试

```powershell
# 健康检查
curl http://localhost:8000/health

# 测试聊天
curl -X POST http://localhost:8000/chat `
  -H "Content-Type: application/json" `
  -d '{\"text\":\"你好\",\"arousal_level\":2}'
```

## 🔍 故障排查

### LLM: ERROR

1. **检查 GEMINI_API_KEY**：
   ```powershell
   python test_local_llm.py
   ```

2. **检查 .env 文件**：
   - 确保 `.env` 文件存在
   - 确保 `GEMINI_API_KEY` 已设置
   - 确保没有 BOM 字符

3. **查看服务日志**：
   - 启动服务时会显示详细的初始化日志
   - 查找 "Failed to initialize PhiBrain" 错误信息

### TTS: ERROR

1. **检查 CARTESIA_API_KEY**：
   - 确保 `.env` 文件中设置了 `CARTESIA_API_KEY`
   - 确保 Key 格式正确

2. **检查服务日志**：
   - 查找 "CARTESIA_API_KEY" 相关的错误信息

### 头像破图

1. **检查 static 文件夹**：
   - 确保 `static/avatar.png` 文件存在
   - 确保文件在项目根目录下

2. **检查静态文件挂载**：
   - 访问 `http://localhost:8000/static/avatar.png`
   - 应该能直接看到图片

## 📝 环境变量检查清单

确保 `.env` 文件包含：

```env
GEMINI_API_KEY=your_gemini_api_key_here
GEMINI_MODEL=gemini-2.0-flash-exp
CARTESIA_API_KEY=your_cartesia_api_key_here
CARTESIA_VOICE_ID=your_voice_id_here
```

## ✅ 成功标志

如果一切正常，您应该看到：

1. **服务启动成功**：
   ```
   INFO:     Uvicorn running on http://0.0.0.0:8000
   ✅ PhiBrain (LLM) initialized successfully.
   ```

2. **健康检查返回**：
   ```json
   {
     "status": "ok",
     "brain_status": "ready",
     "cartesia_status": "ready"
   }
   ```

3. **前端显示**：
   - LLM: OK (绿色)
   - TTS: OK (绿色)
   - 头像正常显示

4. **可以正常对话**：
   - 发送消息后能收到回复
   - 能听到语音播放
