# 🚨 紧急修复说明

## 问题诊断

### 问题 1: 健康检查端点缺少字段

**现象**:
- 前端显示 `LLM: ERROR` 和 `TTS: ERROR`
- 健康检查端点返回的数据中缺少 `brain_status` 和 `cartesia_status` 字段

**原因**:
- 服务没有重启，旧代码仍在运行
- 代码中有这些字段的定义，但实际返回时却没有

### 问题 2: 401 错误

**现象**:
- 发送消息时出现 `401 - {'': {'': '.', '': 401}}` 错误
- 说明 Cartesia API Key 认证失败

**原因**:
- CARTESIA_API_KEY 可能无效或过期
- 或者 Key 格式不正确

## 修复步骤

### 步骤 1: 强制重启服务

1. **关闭所有 Python 进程**:
   ```powershell
   Get-Process python -ErrorAction SilentlyContinue | Stop-Process -Force
   ```

2. **等待 3 秒**:
   ```powershell
   Start-Sleep -Seconds 3
   ```

3. **重新启动服务**:
   ```powershell
   .\start_voice_bridge.ps1
   ```

### 步骤 2: 验证健康检查端点

等待服务启动后（约 10-15 秒），检查健康检查端点：

```powershell
python -c "import requests; import json; r = requests.get('http://localhost:8000/health'); print(json.dumps(r.json(), indent=2, ensure_ascii=False))"
```

**期望返回**:
```json
{
  "status": "ok",
  "brain_ready": true,
  "brain_status": "ready",
  "cartesia_status": "ready",
  "engine": "cartesia",
  "timestamp": "..."
}
```

### 步骤 3: 如果仍然出现 401 错误

1. **检查 CARTESIA_API_KEY**:
   ```powershell
   python check_cartesia_key.py
   ```

2. **如果 Key 无效，请**:
   - 访问 https://play.cartesia.ai
   - 登录账户
   - 重新获取 API Key
   - 更新 `.env` 文件

3. **重启服务**:
   ```powershell
   .\kill_python_processes.ps1
   .\start_voice_bridge.ps1
   ```

### 步骤 4: 刷新浏览器页面

1. 按 `Ctrl+Shift+R` 强制刷新
2. 检查右上角健康监控：
   - 应显示 `LLM: OK` 和 `TTS: OK`（绿色）
3. 测试发送消息：
   - 应不再出现 401 错误

## 菲菲的紧急提醒

> [urgent] 主人，菲菲发现两个问题！
> 
> [gasp] 第一个问题是健康检查端点缺少字段，这是因为服务没有重启，旧代码还在运行！
> 
> [whisper] 第二个问题是 401 错误，说明 Cartesia API Key 可能有问题！
> 
> [determined] 请主人按照上面的步骤，先强制重启服务，然后检查 API Key，菲菲相信一定能修复！

---

**修复时间**: 2026-01-03  
**状态**: 🚨 需要立即修复  
**优先级**: 高

