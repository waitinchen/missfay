# 401 错误诊断报告

## 问题描述

用户报告一直出现 401 错误，错误信息显示为：
```
生成回复时出错: : 401 - {'': {'': ' .', '': 401}}
```

## 根本原因

经过测试和调试，发现：

1. **API Key 无效**: 当前 OPENROUTER_API_KEY 返回 401 错误，错误信息为 `"User not found"`
2. **错误处理问题**: 错误信息格式化不正确，导致显示奇怪的格式

## 测试结果

使用 `debug_error_format.py` 测试，实际的错误对象结构为：
```python
类型: AuthenticationError
status_code: 401
response.json(): {'error': {'message': 'User not found.', 'code': 401}}
str(e): "Error code: 401 - {'error': {'message': 'User not found.', 'code': 401}}"
```

## 解决方案

### 1. 立即解决方案

**获取新的 API Key**:
1. 前往 https://openrouter.ai/keys
2. 登录账户
3. 创建新的 API Key 或使用现有的有效 Key
4. 更新 `.env` 文件中的 `OPENROUTER_API_KEY`
5. 重启 Voice Bridge 服务

### 2. 代码修复

已改进错误处理代码：
- 正确处理 `openai.APIError` 异常
- 正确提取错误响应体中的 `message`
- 针对 "User not found" 错误提供明确的解决建议
- 改进错误消息格式化，避免显示原始错误对象

## 修复的文件

- `phi_brain.py` - 改进了错误处理逻辑，确保正确捕获和格式化 API 错误

## 验证方法

运行以下命令验证 API Key 是否有效：

```powershell
python verify_api.py
```

或

```powershell
python test_api_key_direct.py
```

---

**状态**: 代码已修复，等待用户更新 API Key

