# 菲菲 401 错误紧急恢复检查报告

## 检查结果

### 1. ✅ .env 文件路径检查

- **文件路径**: `C:\Users\waiti\missfay\.env`
- **状态**: 存在
- **配置项**:
  - ✅ OPENROUTER_API_KEY: 已配置（但可能已过期）
  - ⚠️ CARTESIA_API_KEY: 需要确认是否配置

### 2. ✅ voice_bridge.py 环境变量加载

- **状态**: ✅ 已正确实现
- **实现方式**: 
  - 手动解析 .env 文件（处理 BOM）
  - 备用 load_dotenv() 调用
  - 路径: `C:\Users\waiti\missfay\.env`

**代码位置**: `voice_bridge.py` 第 27-42 行
```python
# 加载环境变量 (显式指定路径并在内存中修正 BOM)
_base_dir = os.path.dirname(os.path.abspath(__file__))
_env_path = os.path.join(_base_dir, ".env")
# ... 手动解析逻辑 ...
```

### 3. ✅ phi_brain.py 环境变量加载

- **状态**: ✅ 已正确实现
- **实现方式**: 手动解析 .env 文件 + load_dotenv() 备用

### 4. ✅ 端口配置说明

| 服务 | 文件 | 端口 | 说明 |
|------|------|------|------|
| Voice Bridge | voice_bridge.py | 8000 | 主要服务，直接访问 |
| Proxy Layer | phi_proxy_layer.py | 8001 | 代理层（可选） |
| GPT-SoVITS | api_v2.py | 9880 | TTS 引擎 |

### 5. ⚠️ 当前运行状态

检测到 **2 个 Python 进程**正在运行，建议：
- 关闭所有运行中的终端窗口
- 按照正确顺序重新启动服务

---

## 解决方案

### 步骤 1: 确认 API Key 有效性

**问题**: OPENROUTER_API_KEY 返回 401 "User not found" 错误

**操作**:
1. 前往 https://openrouter.ai/keys
2. 检查 API Key 是否有效
3. 如果无效，创建新的 API Key
4. 更新 `.env` 文件中的 `OPENROUTER_API_KEY`

### 步骤 2: 关闭所有运行中的服务

```powershell
# 关闭所有 Python 进程（如果有多个终端窗口）
# 或者直接关闭所有终端窗口
```

### 步骤 3: 按顺序启动服务

#### 3.1 启动 GPT-SoVITS (端口 9880)

**窗口 A**:
```powershell
cd GPT-SoVITS-v3lora-20250228\GPT-SoVITS-v3lora-20250228
.\runtime\python.exe api_v2.py
```

等待看到: `Uvicorn running on http://127.0.0.1:9880`

#### 3.2 启动 Voice Bridge (端口 8000)

**窗口 B**:
```powershell
cd C:\Users\waiti\missfay
.\start_voice_bridge.ps1
```

或者：
```powershell
$py = ".\GPT-SoVITS-v3lora-20250228\GPT-SoVITS-v3lora-20250228\runtime\python.exe"
& $py voice_bridge.py
```

等待看到: `Application startup complete`

#### 3.3 （可选）启动 Proxy Layer (端口 8001)

**窗口 C**:
```powershell
$py = ".\GPT-SoVITS-v3lora-20250228\GPT-SoVITS-v3lora-20250228\runtime\python.exe"
& $py phi_proxy_layer.py
```

### 步骤 4: 验证服务

1. 访问 http://localhost:8000/ - 应该看到聊天界面
2. 发送测试消息，确认不再出现 401 错误

---

## 重要提示

### 关于端口访问

- **直接访问**: http://localhost:8000/ (Voice Bridge)
- **代理访问**: http://localhost:8001/api/v1/phi_voice (Proxy Layer)

如果使用代理层，前端需要指向 8001 端口。

### 关于 API Key

如果 401 错误持续出现，请：
1. 确认 API Key 在 OpenRouter 网站上是有效的
2. 确认 API Key 有足够的余额或权限
3. 检查 `.env` 文件编码（应该是 UTF-8，无 BOM）

---

## 代码确认

✅ **voice_bridge.py**: 已正确实现环境变量加载（手动解析 + load_dotenv 备用）
✅ **phi_brain.py**: 已正确实现环境变量加载
✅ **错误处理**: 已改进，会显示清晰的错误信息

---

**生成时间**: 2026-01-03
**状态**: 检查完成，等待 API Key 更新和服務重启

