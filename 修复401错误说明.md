# 修复 401 错误说明

## 问题诊断

根据诊断结果：
- ✅ GEMINI_API_KEY 已配置且有效
- ✅ phi_brain.py 已配置为使用 Gemini
- ✅ voice_bridge.py 已配置为使用 Gemini
- ⚠️ voice_bridge.py 中仍有 OPENROUTER_API_KEY 检查（已修复）

## 已修复的问题

1. **清理 OPENROUTER_API_KEY 检查**
   - 已移除 `voice_bridge.py` 中对 OPENROUTER_API_KEY 的检查
   - 改为检查 GEMINI_API_KEY（但不会阻止初始化）

## 解决方案

### 步骤 1: 重启服务

**重要**: 必须重启服务才能应用更改！

1. **关闭所有运行中的服务**:
   - 关闭运行 `voice_bridge.py` 的终端窗口
   - 关闭运行 GPT-SoVITS 的终端窗口

2. **重新启动服务**:
   ```powershell
   # 启动 Voice Bridge
   .\start_voice_bridge.ps1
   ```

### 步骤 2: 验证修复

访问 http://localhost:8000/ 并发送测试消息，应该：
- ✅ 不再出现 401 错误
- ✅ 正常生成回复
- ✅ 正常播放语音

## 如果仍然出现 401 错误

### 可能原因 1: Gemini API 配额问题

如果 Gemini API Key 配额已用完，会出现 429 错误（不是 401）。

**解决方案**:
- 检查 Google AI Studio 的配额设置
- 等待配额重置
- 或使用新的 API Key

### 可能原因 2: 服务未重启

**解决方案**:
- 确保完全关闭所有服务
- 重新启动服务

### 可能原因 3: 浏览器缓存

**解决方案**:
- 清除浏览器缓存
- 或使用无痕模式访问

## 验证清单

- [ ] 已关闭所有运行中的服务
- [ ] 已重新启动 `start_voice_bridge.ps1`
- [ ] GEMINI_API_KEY 已配置在 .env 文件中
- [ ] 访问 http://localhost:8000/ 测试
- [ ] 发送测试消息验证

## 代码更改摘要

### voice_bridge.py

**更改前**:
```python
if not os.getenv("OPENROUTER_API_KEY"):
    logger.error("CRITICAL: OPENROUTER_API_KEY is missing!")
```

**更改后**:
```python
# 已迁移至 Gemini，检查 GEMINI_API_KEY
if not os.getenv("GEMINI_API_KEY"):
    logger.warning("GEMINI_API_KEY not found, but continuing initialization...")
```

---

**修复完成时间**: 2026-01-03  
**状态**: ✅ 代码已修复，等待服务重启
