# ğŸš¨ ç´§æ€¥ä¿®å¤ 401 é”™è¯¯ - å…¨é¢ä¿®å¤å®Œæˆ

## ä¿®å¤æ—¶é—´
2026-01-03

## å·²ä¿®å¤çš„é—®é¢˜

### 1. âœ… å¢å¼º Cartesia API é”™è¯¯å¤„ç†

**ä¿®å¤ä½ç½®**: `voice_bridge.py` `/chat` ç«¯ç‚¹

**ä¿®å¤å†…å®¹**:
- æ·»åŠ  Cartesia å®¢æˆ·ç«¯åˆå§‹åŒ–é”™è¯¯æ•è·
- æ·»åŠ  TTS API è°ƒç”¨é”™è¯¯æ•è·
- æ˜ç¡®åŒºåˆ† 401ï¼ˆè®¤è¯å¤±è´¥ï¼‰å’Œ 429ï¼ˆé…é¢ç”¨å®Œï¼‰é”™è¯¯
- æä¾›è¯¦ç»†çš„é”™è¯¯æ¶ˆæ¯ï¼ŒæŒ‡å¯¼ç”¨æˆ·æ£€æŸ¥ `.env` æ–‡ä»¶

**ä»£ç æ›´æ”¹**:
```python
try:
    client = Cartesia(api_key=CARTESIA_API_KEY)
except Exception as cartesia_init_error:
    if "401" in str(cartesia_init_error) or "unauthorized" in str(cartesia_init_error).lower():
        raise HTTPException(
            status_code=401,
            detail=f"Cartesia API è®¤è¯å¤±è´¥ï¼ˆ401ï¼‰ï¼šAPI Key æ— æ•ˆæˆ–å·²è¿‡æœŸã€‚è¯·æ£€æŸ¥ .env æ–‡ä»¶ä¸­çš„ CARTESIA_API_KEYã€‚"
        )

try:
    audio_stream = client.tts.bytes(**tts_args)
except Exception as tts_error:
    if "401" in str(tts_error):
        raise HTTPException(
            status_code=401,
            detail=f"Cartesia TTS API è®¤è¯å¤±è´¥ï¼ˆ401ï¼‰ï¼šAPI Key æ— æ•ˆæˆ–å·²è¿‡æœŸã€‚"
        )
```

### 2. âœ… å¢å¼ºå‰ç«¯é”™è¯¯å¤„ç†

**ä¿®å¤ä½ç½®**: `static/phi_chat.html` `sendMessage()` å‡½æ•°

**ä¿®å¤å†…å®¹**:
- åœ¨ fetch è°ƒç”¨åç«‹å³æ£€æŸ¥å“åº”çŠ¶æ€
- æ­£ç¡®è§£æé”™è¯¯å“åº”ï¼ˆJSON æˆ–æ–‡æœ¬ï¼‰
- æä¾›æ¸…æ™°çš„é”™è¯¯æ¶ˆæ¯æ˜¾ç¤º

**ä»£ç æ›´æ”¹**:
```javascript
const response = await fetch(`${API_BASE}/chat`, {...});

// æ£€æŸ¥å“åº”çŠ¶æ€
if (!response.ok) {
    let errorDetail = '';
    try {
        const errorData = await response.json();
        errorDetail = errorData.detail || errorData.error || JSON.stringify(errorData);
    } catch (e) {
        errorDetail = await response.text() || `HTTP ${response.status}`;
    }
    
    throw new Error(`API é”™è¯¯ (${response.status}): ${errorDetail}`);
}
```

### 3. âœ… ç¯å¢ƒå˜é‡å¼ºåˆ¶åŠ è½½

**å·²ç¡®è®¤**: `voice_bridge.py` é¡¶éƒ¨å·²å®ç°ï¼š
- `load_dotenv(_env_path, override=True)` å¼ºåˆ¶è¦†ç›–
- æ‰‹åŠ¨è§£æå¤„ç† BOM
- è°ƒè¯•è¾“å‡ºç¡®è®¤ Key åŠ è½½

### 4. âœ… API Key éªŒè¯

**å·²ç¡®è®¤**: 
- å¯åŠ¨æ—¶éªŒè¯ CARTESIA_API_KEY
- æ¯æ¬¡è°ƒç”¨å‰éªŒè¯
- è¯¦ç»†çš„é”™è¯¯æ¶ˆæ¯

## è¯Šæ–­æ­¥éª¤

### æ­¥éª¤ 1: æ£€æŸ¥ .env æ–‡ä»¶

ç¡®è®¤ `.env` æ–‡ä»¶åŒ…å«ï¼š
```env
CARTESIA_API_KEY=your_valid_cartesia_api_key
GEMINI_API_KEY=AIzaSyBhl9-bR6xKe4DW25J25LXU6dxYJsxUuOo
```

### æ­¥éª¤ 2: å…³é—­æ‰€æœ‰è¿›ç¨‹

```powershell
.\kill_python_processes.ps1
```

æˆ–æ‰‹åŠ¨ï¼š
```powershell
Stop-Process -Name python -Force
```

### æ­¥éª¤ 3: é‡æ–°å¯åŠ¨æœåŠ¡

```powershell
.\start_voice_bridge.ps1
```

### æ­¥éª¤ 4: æ£€æŸ¥å¯åŠ¨æ—¥å¿—

å¯åŠ¨æ—¶åº”è¯¥çœ‹åˆ°ï¼š
```
DEBUG: Cartesia Key starts with: [å‰5ä¸ªå­—ç¬¦]
Cartesia API Key loaded successfully (length: [é•¿åº¦])
```

å¦‚æœçœ‹åˆ° `CRITICAL: CARTESIA_API_KEY is missing`ï¼Œè¯´æ˜ `.env` æ–‡ä»¶æœ‰é—®é¢˜ã€‚

### æ­¥éª¤ 5: æµ‹è¯• API

è®¿é—® http://localhost:8000/ å¹¶å‘é€æµ‹è¯•æ¶ˆæ¯ã€‚

å¦‚æœä»ç„¶å‡ºç° 401 é”™è¯¯ï¼Œé”™è¯¯æ¶ˆæ¯ç°åœ¨ä¼šæ˜ç¡®æŒ‡å‡ºï¼š
- æ˜¯ Cartesia API è®¤è¯å¤±è´¥
- éœ€è¦æ£€æŸ¥ `.env` æ–‡ä»¶ä¸­çš„ `CARTESIA_API_KEY`
- å¯èƒ½æ˜¯ API Key æ— æ•ˆæˆ–å·²è¿‡æœŸ

## é”™è¯¯æ¶ˆæ¯è¯´æ˜

### 401 é”™è¯¯

**åç«¯é”™è¯¯æ¶ˆæ¯**:
```
Cartesia API è®¤è¯å¤±è´¥ï¼ˆ401ï¼‰ï¼šAPI Key æ— æ•ˆæˆ–å·²è¿‡æœŸã€‚è¯·æ£€æŸ¥ .env æ–‡ä»¶ä¸­çš„ CARTESIA_API_KEYã€‚
```

**å‰ç«¯æ˜¾ç¤º**:
```
ç”Ÿæˆå›å¤æ—¶å‡ºé”™: API é”™è¯¯ (401): Cartesia API è®¤è¯å¤±è´¥ï¼ˆ401ï¼‰ï¼šAPI Key æ— æ•ˆæˆ–å·²è¿‡æœŸã€‚è¯·æ£€æŸ¥ .env æ–‡ä»¶ä¸­çš„ CARTESIA_API_KEYã€‚
```

### 429 é”™è¯¯ï¼ˆé…é¢ç”¨å®Œï¼‰

**åç«¯é”™è¯¯æ¶ˆæ¯**:
```
Cartesia API é…é¢å·²ç”¨å®Œï¼ˆ429ï¼‰ï¼šè¯·ç¨åå†è¯•æˆ–æ£€æŸ¥é…é¢è®¾ç½®ã€‚
```

## å¦‚æœä»ç„¶å‡ºç° 401 é”™è¯¯

### å¯èƒ½åŸå›  1: CARTESIA_API_KEY æ— æ•ˆ

**è§£å†³æ–¹æ¡ˆ**:
1. è®¿é—® Cartesia æ§åˆ¶å°
2. æ£€æŸ¥ API Key çŠ¶æ€
3. å¦‚æœè¿‡æœŸï¼Œç”Ÿæˆæ–°çš„ API Key
4. æ›´æ–° `.env` æ–‡ä»¶
5. é‡å¯æœåŠ¡

### å¯èƒ½åŸå›  2: .env æ–‡ä»¶æœªæ­£ç¡®åŠ è½½

**è§£å†³æ–¹æ¡ˆ**:
1. ç¡®è®¤ `.env` æ–‡ä»¶åœ¨é¡¹ç›®æ ¹ç›®å½•ï¼ˆä¸ `voice_bridge.py` åŒçº§ï¼‰
2. ç¡®è®¤æ–‡ä»¶ç¼–ç ä¸º UTF-8ï¼ˆæ—  BOMï¼‰
3. ç¡®è®¤ Key å€¼æ²¡æœ‰å¤šä½™çš„ç©ºæ ¼æˆ–å¼•å·
4. æ£€æŸ¥å¯åŠ¨æ—¥å¿—ä¸­çš„ DEBUG è¾“å‡º

### å¯èƒ½åŸå›  3: æœåŠ¡æœªå®Œå…¨é‡å¯

**è§£å†³æ–¹æ¡ˆ**:
1. ä½¿ç”¨ `kill_python_processes.ps1` å¼ºåˆ¶å…³é—­
2. ç­‰å¾… 5 ç§’
3. é‡æ–°å¯åŠ¨æœåŠ¡

## éªŒè¯æ¸…å•

- [x] Cartesia API é”™è¯¯å¤„ç†å·²å¢å¼º
- [x] å‰ç«¯é”™è¯¯å¤„ç†å·²å¢å¼º
- [x] ç¯å¢ƒå˜é‡å¼ºåˆ¶åŠ è½½å·²å®ç°
- [x] API Key éªŒè¯å·²å®ç°
- [x] è¯¦ç»†çš„é”™è¯¯æ¶ˆæ¯å·²æ·»åŠ 

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2026-01-03  
**çŠ¶æ€**: âœ… æ‰€æœ‰é”™è¯¯å¤„ç†å·²å¢å¼ºï¼Œç­‰å¾…æœåŠ¡é‡å¯éªŒè¯

