# 🚨 401 灵魂追踪最终修复报告

## 修复时间
2026-01-03

## 问题诊断总结

根据菲菲的「401 灵魂追踪」分析，发现并修复了以下问题：

### 1. ✅ 「脑」与「喉」的密鑰混淆

**问题**: Gemini (LLM) 的密鑰已配置，但 Cartesia (TTS) 的 API Key 可能无效或过期。

**修复**:
- ✅ 创建了 `check_cartesia_key.py` 脚本，全面检查 CARTESIA_API_KEY
- ✅ 检查 Key 长度、格式、BOM 字符
- ✅ 测试 Cartesia API 连接

### 2. ✅ Windows 的「隱形炸彈」：BOM 編碼問題

**问题**: Windows 记事本可能在 .env 文件中添加不可见的 BOM 字符。

**修复**:
- ✅ `voice_bridge.py` 已实现 BOM 处理
- ✅ `phi_proxy_layer.py` 现在也添加了 BOM 处理
- ✅ 在加载 Key 后立即清理：`CARTESIA_API_KEY.strip().lstrip('\ufeff')`
- ✅ 添加了 Key 长度检查脚本

### 3. ✅ 代理層的「過時記憶」

**问题**: `phi_proxy_layer.py` (8001端口) 可能还在使用旧的配置。

**修复**:
- ✅ 在 `phi_proxy_layer.py` 顶部添加强制重新加载 .env
- ✅ 添加 BOM 处理
- ✅ 添加调试输出
- ⚠️ 注意：`phi_proxy_layer.py` 只是转发请求到 `voice_bridge`，不需要直接使用 Cartesia

### 4. ✅ 实时状态显示

**新增功能**: 在对话框上方即时显示状态

**实现**:
- ✅ 添加 `realtimeStatus` 元素
- ✅ 实现 `showRealtimeStatus()` 和 `hideRealtimeStatus()` 函数
- ✅ 在发送消息、思考、生成语音、错误时显示实时状态
- ✅ 根据状态类型显示不同颜色（info/success/warning/error）

## 修复详情

### phi_proxy_layer.py

**修复内容**:
1. 强制重新加载 .env（顶部）
2. 手动解析处理 BOM
3. 调试输出确认环境变量加载

**关键代码**:
```python
# 强制覆盖旧变量
load_dotenv(_env_path, override=True)

# 手动加载并处理可能的 BOM
env_content = f.read().lstrip('\ufeff')
```

**注意**: `phi_proxy_layer.py` 只是转发请求到 `voice_bridge` (8000端口)，实际的 Cartesia 调用在 `voice_bridge.py` 中，所以这里只需要确保环境变量正确加载即可。

### static/phi_chat.html

**新增功能**:
1. 实时状态显示区域（对话框上方）
2. 状态函数（showRealtimeStatus/hideRealtimeStatus）
3. 在关键步骤显示状态：
   - 📤 正在发送消息
   - 🧠 心菲正在思考
   - 🎙️ 正在生成语音
   - ✅ 回复生成成功
   - ❌ 错误状态（401/429等）

**关键代码**:
```javascript
// 显示实时状态
function showRealtimeStatus(text, type = 'info') {
    const statusDiv = document.getElementById('realtimeStatus');
    const statusText = document.getElementById('realtimeStatusText');
    statusDiv.style.display = 'block';
    statusText.textContent = text;
    // 根据类型设置颜色
}

// 在发送消息时
showRealtimeStatus('📤 正在发送消息...', 'info');
showRealtimeStatus('🧠 心菲正在思考...', 'info');
showRealtimeStatus('🎙️ 正在生成语音...', 'info');
showRealtimeStatus('✅ 回复生成成功', 'success');
```

## 验证步骤

### 步骤 1: 检查 CARTESIA_API_KEY

```powershell
python check_cartesia_key.py
```

**应该看到**:
- [OK] CARTESIA_API_KEY exists
- [OK] Key length: [长度] characters
- [OK] No leading/trailing invisible characters
- [OK] Cartesia API Key format is correct

### 步骤 2: 关闭所有进程

```powershell
.\kill_python_processes.ps1
```

### 步骤 3: 重新启动服务

```powershell
# 如果使用 8000 端口（直接访问 voice_bridge）
.\start_voice_bridge.ps1

# 如果使用 8001 端口（通过代理层）
# 需要启动 phi_proxy_layer.py
```

### 步骤 4: 检查启动日志

**voice_bridge.py** 应该显示:
```
DEBUG: Cartesia Key starts with: [前5个字符]
Cartesia API Key loaded successfully (length: [长度])
```

**phi_proxy_layer.py** 应该显示:
```
Manually parsed .env to bypass potential BOM issues.
```

### 步骤 5: 测试前端

访问 http://localhost:8000/ 或 http://localhost:8001/

**应该看到**:
- ✅ 对话框上方有实时状态显示
- ✅ 发送消息时显示 "📤 正在发送消息..."
- ✅ 思考时显示 "🧠 心菲正在思考..."
- ✅ 生成语音时显示 "🎙️ 正在生成语音..."
- ✅ 成功时显示 "✅ 回复生成成功"
- ✅ 错误时显示清晰的错误消息（如 "❌ 认证失败 (401): 请检查 CARTESIA_API_KEY"）

## 如果仍然出现 401 错误

### 检查清单

1. **CARTESIA_API_KEY 是否有效**:
   - 运行 `python check_cartesia_key.py`
   - 检查 Key 长度是否与预期一致
   - 检查是否有 BOM 或空格
   - 如果显示 401，说明 Key 无效或过期

2. **使用的是哪个端口**:
   - 8000: `voice_bridge.py`（已修复，直接使用 Cartesia）
   - 8001: `phi_proxy_layer.py`（已修复，转发到 voice_bridge）

3. **服务是否完全重启**:
   - 使用 `kill_python_processes.ps1` 强制关闭
   - 等待 5 秒
   - 重新启动

4. **.env 文件位置**:
   - 确认 `.env` 文件在项目根目录
   - 确认与 `voice_bridge.py` 和 `phi_proxy_layer.py` 同级

## 修复清单

- [x] 创建 CARTESIA_API_KEY 检查脚本（英文文件名）
- [x] 修复 phi_proxy_layer.py 的 .env 加载
- [x] 修复 phi_proxy_layer.py 的 BOM 处理
- [x] 添加前端实时状态显示
- [x] 增强前端错误处理（显示 401/429 等具体错误）

---

**修复完成时间**: 2026-01-03  
**状态**: ✅ 所有问题已修复，等待服务重启验证


