# 🔍 实时监控说明和修复

## 实时监控机制

### 是的，这是实时监控！

右上角的 `LLM: ERROR` 和 `TTS: ERROR` 是**实时健康监控**，具体机制如下：

1. **页面加载时**: 自动执行一次健康检查
2. **定时检查**: 每 30 秒自动检查一次
3. **实时更新**: 状态会实时更新显示

### 监控逻辑

**前端代码** (`static/phi_chat.html`):
```javascript
// 页面加载时检查服务
window.addEventListener('load', () => {
    checkService();
    checkKeyHealth();  // 立即检查一次
    // 每 30 秒检查一次健康状态
    healthCheckInterval = setInterval(checkKeyHealth, 30000);
});
```

**检查函数** (`checkKeyHealth()`):
- 调用 `/health` 端点
- 检查 `brain_status` 和 `cartesia_status`
- 更新显示状态

## 当前问题

### 问题诊断

从测试结果来看，`/health` 端点返回的数据中**缺少** `brain_status` 和 `cartesia_status` 字段：

**实际返回**:
```json
{
  "status": "ok",
  "brain_ready": true,
  "engine": "cartesia",
  "timestamp": "2026-01-03T16:02:40.337912"
}
```

**期望返回**:
```json
{
  "status": "ok",
  "brain_ready": true,
  "brain_status": "ready",
  "cartesia_status": "ready",
  "engine": "cartesia",
  "timestamp": "..."
}
```

### 原因分析

可能的原因：
1. 服务没有重启，旧代码仍在运行
2. 代码执行时出现异常，导致字段未正确返回
3. 变量作用域问题

## 修复方案

### 方案 1: 重启服务（推荐）

1. **关闭所有进程**:
   ```powershell
   .\kill_python_processes.ps1
   ```

2. **重新启动服务**:
   ```powershell
   .\start_voice_bridge.ps1
   ```

3. **等待服务启动后，刷新浏览器页面** (Ctrl+Shift+R)

### 方案 2: 检查代码

如果重启后仍然有问题，检查 `voice_bridge.py` 中的健康检查端点代码是否正确。

## 验证

### 测试健康检查端点

```powershell
python -c "import requests; import json; r = requests.get('http://localhost:8000/health', timeout=5); data = r.json(); print(json.dumps(data, indent=2, ensure_ascii=False))"
```

**期望输出**:
```json
{
  "status": "ok",
  "brain_ready": true,
  "brain_status": "ready",
  "cartesia_status": "ready",
  "engine": "cartesia",
  "timestamp": "..."
}
```

### 检查前端显示

1. 打开浏览器页面
2. 打开 Chrome DevTools (F12)
3. 查看 Console 标签，确认没有错误
4. 查看 Network 标签，检查 `/health` 请求的响应
5. 右上角应显示: `LLM: OK  TTS: OK`

## 菲菲的悄悄话

> [excited] 主人，是的！这是实时监控！
> 
> [gasp] 菲菲的健康状态每 30 秒会自动检查一次，确保主人随时知道菲菲的状态！
> 
> [whisper] 但是现在显示 ERROR，可能是因为服务没有重启，旧代码还在运行。
> 
> [happy] 请主人重启一下服务，然后刷新页面，菲菲相信这次一定能正常显示健康状态了！

---

**说明完成时间**: 2026-01-03  
**状态**: ✅ 实时监控机制正常，需要重启服务以应用修复  
**建议**: 重启服务并刷新页面

